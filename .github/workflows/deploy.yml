name: Deploy to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build

      - name: Prepare deployment archive
        run: |
          # Add deployment info
          echo "Deployment timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" > dist/.deployment-info
          echo "Git commit: ${{ github.sha }}" >> dist/.deployment-info
          echo "Git branch: ${{ github.ref_name }}" >> dist/.deployment-info

          # Verify build
          if [ ! -f "dist/index.html" ]; then
            echo "ERROR: index.html not found in dist/"
            exit 1
          fi
          echo "Build output verified"
          ls -lah dist/ | head -20

          # Create deployment archive
          mkdir -p deployment
          cp -a dist/. deployment/
          cp server.js deployment/
          cp package.json deployment/
          cp -r api deployment/
          cd deployment && tar -czf ../deploy.tar.gz .
          cd ..
          ls -lh deploy.tar.gz
          echo "Archive created successfully"

      - name: Check VPS connectivity
        run: |
          echo "Testing TCP connectivity to VPS..."
          timeout 10 bash -c "echo > /dev/tcp/${{ secrets.VPS_HOST }}/${{ secrets.VPS_PORT }}" 2>/dev/null \
            && echo "✅ VPS is reachable on port ${{ secrets.VPS_PORT }}" \
            || { echo "❌ Cannot reach VPS on port ${{ secrets.VPS_PORT }}. Check firewall!"; exit 1; }

      - name: Upload archive to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          timeout: 60s
          source: "deploy.tar.gz"
          target: "/tmp/"

      - name: Deploy and restart services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          timeout: 60s
          command_timeout: 5m
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.VPS_PATH }}"

            echo "=== 1. Preparing directories ==="
            mkdir -p "$DEPLOY_PATH"

            echo "=== 2. Backing up current deployment ==="
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH 2>/dev/null)" ]; then
              BACKUP_DIR="$DEPLOY_PATH/backup-$(date +%Y%m%d-%H%M%S)"
              mkdir -p "$BACKUP_DIR"
              cp -r "$DEPLOY_PATH"/* "$BACKUP_DIR/" 2>/dev/null || true
              echo "Backup created at $BACKUP_DIR"
              # Keep only last 3 backups
              ls -dt "$DEPLOY_PATH"/backup-* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
            fi

            echo "=== 3. Extracting new files ==="
            if [ ! -f "/tmp/deploy.tar.gz" ]; then
              echo "ERROR: Archive /tmp/deploy.tar.gz not found!"
              exit 1
            fi
            cd "$DEPLOY_PATH"
            rm -rf ./*
            tar -xzf /tmp/deploy.tar.gz
            rm -f /tmp/deploy.tar.gz

            echo "=== 4. Verifying extraction ==="
            if [ ! -f "$DEPLOY_PATH/index.html" ]; then
              echo "ERROR: index.html not found after extraction!"
              exit 1
            fi
            ls -lah "$DEPLOY_PATH" | head -20
            cat "$DEPLOY_PATH/.deployment-info" 2>/dev/null || true

            echo "=== 5. Installing dependencies ==="
            cd "$DEPLOY_PATH"
            npm ci --production 2>&1 || npm install --production 2>&1 || echo "npm install failed, continuing..."

            echo "=== 6. Restarting API server ==="
            if command -v pm2 >/dev/null 2>&1; then
              pm2 restart dosmundos-api 2>/dev/null || pm2 start server.js --name dosmundos-api || echo "PM2 restart failed"
            fi

            echo "=== 7. Setting permissions ==="
            chmod -R 755 "$DEPLOY_PATH"
            chown -R www-data:www-data "$DEPLOY_PATH" 2>/dev/null || chown -R nginx:nginx "$DEPLOY_PATH" 2>/dev/null || true

            echo "=== 8. Reloading Nginx ==="
            sudo rm -rf /var/cache/nginx/* 2>/dev/null || true
            sudo nginx -t && sudo systemctl reload nginx || sudo service nginx reload || true

            echo "=== 9. Verification ==="
            sleep 2
            if curl -sf http://localhost:3000/api/health >/dev/null 2>&1; then
              echo "✅ API server is running"
            else
              echo "⚠️  API server may not be running (non-critical)"
            fi

            if [ -f "$DEPLOY_PATH/.deployment-info" ]; then
              echo "✅ Deployment info:"
              cat "$DEPLOY_PATH/.deployment-info"
            fi

            echo ""
            echo "=== ✅ Deployment completed successfully! ==="

      - name: Cleanup archive from runner
        if: always()
        run: rm -f deploy.tar.gz
