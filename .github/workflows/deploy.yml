name: Deploy to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build
        
      - name: Add deployment timestamp
        run: |
          echo "Deployment timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" > dist/.deployment-info
          echo "Git commit: ${{ github.sha }}" >> dist/.deployment-info
          echo "Git branch: ${{ github.ref_name }}" >> dist/.deployment-info

      - name: Verify build output
        run: |
          echo "Checking build output..."
          ls -lah dist/ | head -20
          if [ ! -f "dist/index.html" ]; then
            echo "ERROR: index.html not found in dist/"
            exit 1
          fi
          echo "Build output verified"

      - name: Create deployment archive
        run: |
          # Prepare deployment directory
          mkdir -p deployment
          
          # Copy frontend build
          cp -a dist/. deployment/
          
          # Copy backend files
          cp server.js deployment/
          cp package.json deployment/
          cp -r api deployment/
          
          # Create tar archive
          cd deployment && tar -czf ../deploy.tar.gz .
          cd ..
          ls -lh deploy.tar.gz
          echo "Archive created successfully"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 600s
          debug: true
          script_stop: true
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.VPS_PATH }}"
            echo "=== Starting deployment to $DEPLOY_PATH ==="
            
            # Create directories
            mkdir -p $DEPLOY_PATH
            mkdir -p /tmp/deployment
            
            # Clean any existing old archive
            rm -f /tmp/deploy.tar.gz
            rm -f /tmp/deploy.zip
            
            echo "=== Deployment environment prepared ==="

      - name: Upload archive to VPS
        uses: appleboy/scp-action@v0.1.7
        timeout-minutes: 10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60s
          debug: true
          source: "deploy.tar.gz"
          target: "/tmp/"

      - name: Extract and finalize deployment
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 600s
          debug: true
          script_stop: true
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.VPS_PATH }}"
            
            # Verify archive exists
            if [ ! -f "/tmp/deploy.tar.gz" ]; then
              echo "ERROR: Archive /tmp/deploy.tar.gz not found!"
              exit 1
            fi

            # Backup current deployment
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              BACKUP_DIR="$DEPLOY_PATH/backup-$(date +%Y%m%d-%H%M%S)"
              mkdir -p $BACKUP_DIR
              cp -r $DEPLOY_PATH/* $BACKUP_DIR/ 2>/dev/null || true
              echo "Backup created at $BACKUP_DIR"
            fi

            # Extract new files
            echo "Extracting new files to $DEPLOY_PATH..."
            cd $DEPLOY_PATH
            rm -rf ./*
            tar -xzf /tmp/deploy.tar.gz

            # Cleanup
            rm -f /tmp/deploy.tar.gz

            # Verify deployment
            if [ ! -f "$DEPLOY_PATH/index.html" ]; then
              echo "ERROR: index.html not found after extraction!"
              exit 1
            fi

            # Install dependencies
            if [ -f "$DEPLOY_PATH/package.json" ]; then
              npm ci --prefix $DEPLOY_PATH
            fi

            # Restart API server
            if command -v pm2 >/dev/null 2>&1; then
              cd $DEPLOY_PATH
              pm2 restart dosmundos-api || pm2 start server.js --name dosmundos-api
            fi

            # Set permissions
            chmod -R 755 $DEPLOY_PATH
            chown -R www-data:www-data $DEPLOY_PATH || chown -R nginx:nginx $DEPLOY_PATH || true

            # Reload nginx
            sudo nginx -t && sudo systemctl reload nginx

            # Verify running processes
            if curl -s http://localhost:3000 >/dev/null; then
              echo "✅ Server is running"
            else
              echo "⚠️  Server might not be running. Check PM2 logs."
            fi

            echo "=== Deployment completed successfully! ==="

      - name: Cleanup
        if: always()
        run: |
          rm -f deploy.tar.gz
          rm -rf deployment
