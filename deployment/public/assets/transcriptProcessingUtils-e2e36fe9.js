import{l as t}from"./index-13791832.js";const e=12e4,r=(t,e)=>{if(!t||t.length<=e)return t.length;let r=e,n=Math.max(0,e-450);for(let l=r;l>=n;l--)if("."===t[l]||"?"===t[l]||"!"===t[l])return l+1<t.length&&" "===t[l+1]?l+2:l+1;let s=-1;for(let l=r;l>=n;l--)if(" "===t[l]){s=l;break}return-1!==s?s+1:e},n=t=>{const n=t.end-t.start;if(n<=e)return[t];const s=[];let l=t.start;if(t.words&&t.words.length>0){let r=[],n="";for(let i=0;i<t.words.length;i++){const a=t.words[i],o=a.end;if(o-l>e&&r.length>0){let e=r.length-1,h=r.length-1;for(let t=h;t>=0;t--){const n=r[t];if(o-n.start>3e4&&t<h)break;if(/[.?!]$/.test(n.text)){e=t;break}}const d=r.slice(0,e+1),g=d.map((t=>t.text)).join(" "),u=d[d.length-1].end;if(s.push({...t,start:l,end:u,text:g,words:[...d],id:`${t.id||t.start}-split-${s.length}-${Date.now()}`}),r=r.slice(e+1),n=r.map((t=>t.text)).join(" "),l=r.length>0?r[0].start:o,0===r.length){if(!(i<t.words.length))continue;r.push(a),n=a.text,l=a.start}else r.push(a),n=r.map((t=>t.text)).join(" ")}else r.push(a),n=n?`${n} ${a.text}`:a.text}r.length>0&&s.push({...t,start:l,end:t.end,text:n.trim(),words:r,id:`${t.id||t.start}-split-${s.length}-${Date.now()}`})}else{const l=Math.ceil(n/e);let i=0;for(let a=0;a<l;a++){const o=t.start+a*e,h=Math.min(e,t.end-o),d=o+h,g=h/n;let u,c=Math.floor(t.text.length*g);a===l-1?u=t.text.length-i:(u=r(t.text.substring(i),c),i+u>t.text.length&&(u=t.text.length-i));const p=t.text.substring(i,i+u);i+=u,p.trim()&&s.push({...t,start:o,end:d,text:p.trim(),words:[],id:`${t.id||t.start}-textsplit-${a}-${Date.now()}`})}}return s.length>0?s:[t]},s=(t,e=12e4)=>{if(!Array.isArray(t)||0===t.length)return[];const r=[];let s=[],l=null;for(let i=0;i<t.length;i++){const a=t[i];if(0!==s.length)if(a.end-l>e)if(a.end-a.start>e){const t=n(a);if(t.length>0){r.push([...s,t[0]]);for(let e=1;e<t.length;e++)r.push([t[e]])}else r.push([...s,a]);s=[],l=null}else r.push([...s]),s=[a],l=a.start,a.end;else s.push(a),a.end;else l=a.start,a.end,s.push(a)}return s.length>0&&r.push([...s]),r},l=e=>{if(!e||!Array.isArray(e.utterances))return{...e,utterances:[]};const r=e.utterances,s=((t,e)=>{if(!Array.isArray(t)||!Array.isArray(e)||0===t.length||0===e.length)return t.map((()=>[]));const r=new Array(t.length);for(let s=0;s<t.length;s++)r[s]=[];let n=0;for(let s=0;s<t.length;s++){const l=t[s],i=l.start,a=l.end;for(;n<e.length&&e[n].end<i;)n++;let o=n;for(;o<e.length;){const t=e[o];if(t.start>a)break;(void 0===t.confidence||t.confidence>0)&&r[s].push(t),o++}n=o}return r})(r,Array.isArray(e.words)?e.words:[]);let l=0;const i=r.flatMap(((e,r)=>{const i={...e,words:s[r]&&s[r].length>0?s[r]:e.words||[]},a=n(i);return a.length>1&&(l+=a.length-1,t.debug("[TranscriptProcessing] Long utterance split:",{originalId:e.id||e.start,originalDuration:e.end-e.start,originalTextLength:(e.text||"").length,splitCount:a.length,hasWords:!!(i.words&&i.words.length>0)})),e.end-e.start>3e5&&t.debug("[TranscriptProcessing] Long utterance detected:",{start:e.start,end:e.end,durationMs:e.end-e.start,originalTextLen:(e.text||"").length,splitCount:a.length}),a})).filter((t=>t.text&&""!==t.text.trim()));return l>0&&t.info("[TranscriptProcessing] Segment splitting completed:",{originalCount:r.length,finalCount:i.length,totalSplits:l}),{...e,utterances:i,words:e.words}},i=t=>{if(!t)return{utterances:[]};return{utterances:(Array.isArray(t.utterances)?t.utterances:[]).filter((t=>t&&"number"==typeof t.start&&"number"==typeof t.end&&"string"==typeof t.text)).map((t=>{const e={start:t.start,end:t.end,text:t.text};return void 0!==t.id&&(e.id=t.id),void 0!==t.speaker&&null!==t.speaker&&""!==String(t.speaker).trim()&&(e.speaker=t.speaker),e}))}},a=t=>Array.isArray(t)&&0!==t.length?t.map((t=>t.text||"")).join(" "):"";export{i as buildEditedTranscriptData,a as getFullTextFromUtterances,l as processTranscriptData,n as splitLongUtterance,s as splitTranscriptToSegments};
