# üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏-–∞—É–¥–∏–æ

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ?

–í —Ñ–∞–π–ª–µ `/api/proxy-audio.js` –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã 4 –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ OPTIONS –∑–∞–ø—Ä–æ—Å–æ–≤** –¥–ª—è CORS preflight
2. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏** –≤ –æ—Ç–≤–µ—Ç
3. ‚úÖ **–ò–∑–º–µ–Ω–µ–Ω —Å–ø–æ—Å–æ–± –ø–µ—Ä–µ–¥–∞—á–∏ –ø–æ—Ç–æ–∫–∞** —Å `.getReader()` –Ω–∞ `.pipe()`
4. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ** (`Accept: audio/*`)

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å?

```
–ë—Ä–∞—É–∑–µ—Ä                        –ü—Ä–æ–∫—Å–∏ (/api/proxy-audio)           Hostinger
   |                                   |                                |
   |------ OPTIONS preflight ---------->|                                |
   |<-- 200 OK (CORS headers) ---------|                                |
   |                                   |                                |
   |------ GET /api/proxy-audio?url=... |                                |
   |                                   |------ GET (—Å Range) ---------->|
   |                                   |<---- 200/206 (–∞—É–¥–∏–æ –ø–æ—Ç–æ–∫) ---|
   |<-- 200 OK (CORS headers) ---------|                                |
   |<== audio stream (pipe) ===========|                                |
   |                                   |                                |
   ‚úÖ –ê—É–¥–∏–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è!
```

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –°–ø–æ—Å–æ–± 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ DevTools –±—Ä–∞—É–∑–µ—Ä–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–ª–µ–µ—Ä–æ–º
2. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12 ‚Üí Network tab)
3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ —ç–ø–∏–∑–æ–¥
4. –ù–∞–π–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å `/api/proxy-audio?url=...`
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - ‚úÖ Status –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **200** –∏–ª–∏ **206**
   - ‚úÖ Response Headers –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
     ```
     Content-Type: audio/mpeg (–∏–ª–∏ audio/*)
     Content-Length: [—Ä–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö]
     Accept-Ranges: bytes
     Access-Control-Allow-Origin: *
     ```
   - ‚úÖ Type –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **xhr** –∏–ª–∏ **fetch** (–Ω–µ –∫—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç)

### –°–ø–æ—Å–æ–± 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ Console –±—Ä–∞—É–∑–µ—Ä–∞

–û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Console –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```javascript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–∫—Å–∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ OPTIONS
fetch('/api/proxy-audio?url=https%3A%2F%2Fsilver-lemur-512881.hostingersite.com%2Ffiles%2Faudio%2F2025-10-29_RU-1762981066683.mp3', {
  method: 'OPTIONS'
})
.then(r => {
  console.log('Status:', r.status);
  console.log('CORS Headers:');
  console.log('  Access-Control-Allow-Origin:', r.headers.get('Access-Control-Allow-Origin'));
  console.log('  Access-Control-Allow-Methods:', r.headers.get('Access-Control-Allow-Methods'));
  return r;
})
.catch(e => console.error('–û—à–∏–±–∫–∞:', e));
```

–î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
```
Status: 200
CORS Headers:
  Access-Control-Allow-Origin: *
  Access-Control-Allow-Methods: GET, HEAD, OPTIONS
```

### –°–ø–æ—Å–æ–± 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ cURL (–µ—Å–ª–∏ –µ—Å—Ç—å VPS –¥–æ—Å—Ç—É–ø)

```bash
# –¢–µ—Å—Ç OPTIONS
curl -i -X OPTIONS "https://dosmundos.pe/api/proxy-audio?url=https%3A%2F%2Fsilver-lemur-512881.hostingersite.com%2Ffiles%2Faudio%2F2025-10-29_RU-1762981066683.mp3"

# –¢–µ—Å—Ç GET (–ø–µ—Ä–≤—ã–µ 1024 –±–∞–π—Ç–∞)
curl -i -H "Range: bytes=0-1023" "https://dosmundos.pe/api/proxy-audio?url=https%3A%2F%2Fsilver-lemur-512881.hostingersite.com%2Ffiles%2Faudio%2F2025-10-29_RU-1762981066683.mp3" | head -20
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
HTTP/1.1 206 Partial Content
Content-Type: audio/mpeg
Content-Range: bytes 0-1023/[total-size]
Content-Length: 1024
Accept-Ranges: bytes
Access-Control-Allow-Origin: *
```

## –ï—Å–ª–∏ –∞—É–¥–∏–æ –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏:

### –û—à–∏–±–∫–∞: "CORS policy: ..."
- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ `/api/proxy-audio.js`
- –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+Shift+Del)

### –û—à–∏–±–∫–∞: "Failed to load audio"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ URL –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `encodeURIComponent`)
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞—É–¥–∏–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ Hostinger
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–æ–∫—Å–∏ –Ω–∞ VPS

### –ê—É–¥–∏–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–æ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±—Ä–∞—É–∑–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `Content-Type: audio/mpeg`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ DevTools ‚Üí Network, —á—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞—É–¥–∏–æ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ª–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∫–µ—à–∞

## –ì–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã?

1. **–û—Å–Ω–æ–≤–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** `/api/proxy-audio.js`
2. **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è URL:** `/src/lib/storageRouter.js` (—Ñ—É–Ω–∫—Ü–∏—è `getCorrectAudioUrl`)
3. **–ó–∞–≥—Ä—É–∑–∫–∞ –≤ –ø–ª–µ–µ—Ä:** `/src/hooks/player/usePlayerPlayback.js` (—Ñ—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `audioElement.src`)

## –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∫—Å–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º:

```bash
node test-proxy.js
```

–ó–∞—Ç–µ–º –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
```
http://localhost:3000/api/proxy-audio?url=https%3A%2F%2Fsilver-lemur-512881.hostingersite.com%2Ffiles%2Faudio%2F2025-10-29_RU-1762981066683.mp3
```

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω—É–∂–Ω–æ:

1. –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:
   ```bash
   git add api/proxy-audio.js
   git commit -m "fix: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã CORS –∏ –ø–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∞—É–¥–∏–æ –≤ –ø—Ä–æ–∫—Å–∏"
   ```

2. –ó–∞–ø—É—à–∏—Ç—å –Ω–∞ Vercel/Netlify (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

3. –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã?

1. –î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä:
   ```javascript
   console.log('[ProxyAudio] Request to:', audioElement.src);
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ VPS:
   ```bash
   tail -f /var/log/api-proxy.log
   ```

3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `strace` –∏–ª–∏ `tcpdump` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

- ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ `/api/proxy-audio`
- ‚úÖ CORS preflight (OPTIONS) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `.pipe()` –≤–º–µ—Å—Ç–æ `.getReader()`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è Range –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è seek –≤ –ø–ª–µ–µ—Ä–µ
- ‚úÖ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–ø–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ —Ä–∞–∑–º–µ—Ä–µ

**–ü—Ä–æ–±–ª–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞! üéâ**
